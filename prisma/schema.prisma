generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model InvoiceCounter {
  id          Int      @id @default(autoincrement())
  seriesKey   String   @unique @default("INV")
  lastNumber  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id                     String    @id @default(uuid())
  invoiceNumber          String    @unique
  uuid                   String    @unique @default(uuid())
  invoiceTypeCode        String    // 380, 381, 383, 386, 388
  invoiceTypeCodeName    String    // 0211010, 0211011, etc.
  invoiceCategory        String    // STANDARD, SIMPLIFIED
  issueDateTime          DateTime
  
  // EGS Reference
  commonName             String    // Reference to EgsUnit
  egsUnit                EgsUnit   @relation(fields: [commonName], references: [commonName])
  
  // Seller
  sellerName             String
  sellerVatNumber        String
  sellerStreet           String    @default("Unknown")
  sellerBuildingNumber   String    @default("0000")
  sellerCity             String    @default("Riyadh")
  sellerDistrict         String    @default("District")
  sellerCountryCode      String    @default("SA")
  sellerPostalCode       String    @default("00000")
  
  // Buyer
  buyerName              String?
  buyerVatNumber         String?
  buyerStreet            String?
  buyerBuildingNumber    String?
  buyerCity              String?
  buyerDistrict          String?
  buyerCountryCode       String?
  buyerPostalCode        String?
  
  // References (for Credit/Debit Notes)
  referenceInvoiceNumber String?
  referenceUUID          String?
  referenceIssueDate     DateTime?
  
  // Advance Payments
  prepaidAmount          Float?    @default(0)
  remainingAmount        Float?    @default(0)
  
  // Totals
  subTotal               Float
  vatAmount              Float
  totalAmount            Float
  currency               String    @default("SAR")
  
  // Signed XML Storage
  signedXml              String?   @db.Text
  qrCode                 String?   @db.Text

  // Status
  status                 String    @default("ISSUED") // ISSUED, CLEARED, REPORTED, REJECTED
  
  // Relations
  items                  InvoiceItem[]
  hash                   InvoiceHash?
  submission             ZatcaSubmission?
  
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  @@index([invoiceNumber])
  @@index([uuid])
  @@index([commonName])
}

model InvoiceItem {
  id            String  @id @default(uuid())
  invoiceId     String
  invoice       Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description   String
  quantity      Float
  unitPrice     Float
  vatRate       Float
  vatAmount     Float
  totalAmount   Float
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model InvoiceHash {
  id                  String  @id @default(uuid())
  invoiceId           String  @unique
  invoice             Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  previousInvoiceHash String?
  currentInvoiceHash  String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ZatcaSubmission {
  id              String   @id @default(uuid())
  invoiceId       String   @unique
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  submissionType  String   // CLEARANCE, REPORTING
  zatcaStatus     String   @default("PENDING") // PENDING, CLEARED, REPORTED, REJECTED
  reportingStatus String?  // From ZATCA: REPORTED, NOT_REPORTED, etc.
  clearanceStatus String?  // From ZATCA: CLEARED, NOT_CLEARED, etc.
  attemptCount    Int      @default(0)
  lastAttemptAt   DateTime?
  qrCode          String?  @db.Text
  zatcaResponse   Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model EgsUnit {
  id                        String    @id @default(uuid())
  commonName                String    @unique
  serialNumber              String
  organizationIdentifier    String
  organizationUnitName      String
  organizationName          String
  countryName               String
  invoiceType               String
  // Detailed Address Fields
  street                 String    @default("Unknown")
  buildingNumber         String    @default("0000")
  city                   String    @default("Riyadh")
  district               String    @default("District")
  postalCode             String    @default("00000")
  countryCode            String    @default("SA")
  industryBusinessCategory  String
  production                Boolean   @default(false)

  csr                       String    @db.Text
  privateKey                String    @db.Text
  onboardingConfig           String?   @db.Text
  propertyId                 String?


  // Compliance CSID (Temporary, for checks)
  complianceBinarySecurityToken String?   @db.Text
  complianceSecret              String?   @db.Text
  complianceRequestId           String?

  // Production CSID (Permanent, for signing)
  productionBinarySecurityToken String?   @db.Text
  productionSecret              String?   @db.Text
  productionRequestId           String?

  // CURRENT ACTIVE TOKENS (Used by InvoiceService)
  binarySecurityToken       String?   @db.Text
  secret                    String?   @db.Text
  requestId                 String?

  // Relations
  invoices                  Invoice[]

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  @@index([commonName])
}

